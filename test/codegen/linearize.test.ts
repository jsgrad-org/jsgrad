import { append_to_block, BasicBlock, block_merge, block_reorder, disp, linearize_uop } from '../../denograd/codegen/linearize.ts'
import { compare } from '../helpers.ts'
import { dtypes } from '../../denograd/dtype.ts'
import { KernelInfo, Ops, UOp } from '../../denograd/ops.ts'

Deno.test(
  'disp',
  compare(
    [],
    disp,
    'out(tiny.codegen.linearize.disp(*data))',
  ),
)
Deno.test(
  'append_to_block',
  compare(
    [
      [[new Map([[new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), []], [new UOp(Ops.CONST, dtypes.int, [], 0), []], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), []], [new UOp(Ops.CONST, dtypes.float, [], 1.0), []], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), []], [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new KernelInfo(0, 0, false)), []]]), new Map([[new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.CONST, dtypes.int, [], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)]], [new UOp(Ops.CONST, dtypes.float, [], 1.0), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)]], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new KernelInfo(0, 0, false))]]])], new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new BasicBlock([], [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new KernelInfo(0, 0, false))], undefined))],
      [[new Map([[new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), []], [new UOp(Ops.CONST, dtypes.int, [], 0), []], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), []], [new UOp(Ops.CONST, dtypes.float, [], 1.0), []], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), []], [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new KernelInfo(0, 0, false)), []]]), new Map([[new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.CONST, dtypes.int, [], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)]], [new UOp(Ops.CONST, dtypes.float, [], 1.0), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)]], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new KernelInfo(0, 0, false))]]])], new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], new BasicBlock([], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new KernelInfo(0, 0, false))], undefined))],
      [[new Map([[new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), []], [new UOp(Ops.CONST, dtypes.int, [], 0), []], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), []], [new UOp(Ops.CONST, dtypes.float, [], 1.0), []], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), []], [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new KernelInfo(0, 0, false)), []]]), new Map([[new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.CONST, dtypes.int, [], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)]], [new UOp(Ops.CONST, dtypes.float, [], 1.0), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)]], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new KernelInfo(0, 0, false))]]])], new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.float, [], 1.0)], new BasicBlock([], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new KernelInfo(0, 0, false))], undefined))],
      [[new Map([[new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), []], [new UOp(Ops.CONST, dtypes.int, [], 0), []], [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), []], [new UOp(Ops.CONST, dtypes.float, [], 1.0), []], [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), []], [new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined), []], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined), []], [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)], new KernelInfo(0, 0, false)), []]]), new Map([[new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.CONST, dtypes.int, [], 0), [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.CONST, dtypes.float, [], 1.0), [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)]], [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), [new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)]], [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)]], [new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)]], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined), [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)], new KernelInfo(0, 0, false))]]])], new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)], new BasicBlock([], [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)], new KernelInfo(0, 0, false))], undefined))],
      [[new Map([[new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), []], [new UOp(Ops.CONST, dtypes.int, [], 0), []], [new UOp(Ops.CONST, dtypes.int, [], 10), []], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0), [new UOp(Ops.BLOCKSTART, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)]], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)]], [new UOp(Ops.CONST, dtypes.float, [], 0.0), []], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined), [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)]], [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)], new KernelInfo(0, 0, false)), []]]), new Map([[new UOp(Ops.CONST, dtypes.int, [], 0), [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)]], [new UOp(Ops.CONST, dtypes.int, [], 10), [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)]], [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)]], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)]], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)]], [new UOp(Ops.CONST, dtypes.float, [], 0.0), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)]], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined), [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)], new KernelInfo(0, 0, false))]]])], new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], new BasicBlock([new UOp(Ops.BLOCKSTART, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined))],
      [[new Map([[new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), []], [new UOp(Ops.CONST, dtypes.int, [], 0), []], [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), []], [new UOp(Ops.CONST, dtypes.float, [], 1.0), []], [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), []], [new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined), []], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined), []], [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)], new KernelInfo(0, 0, false)), []]]), new Map([[new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.CONST, dtypes.int, [], 0), [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.CONST, dtypes.float, [], 1.0), [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)]], [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), [new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)]], [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)]], [new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)]], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined), [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)], new KernelInfo(0, 0, false))]]])], new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], new BasicBlock([], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined), new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)], new KernelInfo(0, 0, false))], undefined))],
    ],
    append_to_block,
    'out(tiny.codegen.linearize.append_to_block(*data))',
  ),
)
Deno.test(
  'block_merge',
  compare(
    [
      [new Map([[new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.CONST, dtypes.int, [], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)]], [new UOp(Ops.CONST, dtypes.float, [], 1.0), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)]], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new KernelInfo(0, 0, false))]]]), new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.float, [], 1.0)], new BasicBlock([], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new KernelInfo(0, 0, false))], undefined))],
      [new Map([[new UOp(Ops.CONST, dtypes.int, [], 0), [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)]], [new UOp(Ops.CONST, dtypes.int, [], 10), [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)]], [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)]], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)]], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)]], [new UOp(Ops.CONST, dtypes.float, [], 0.0), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)]], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined), [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)], new KernelInfo(0, 0, false))]]]), new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], new BasicBlock([new UOp(Ops.BLOCKSTART, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined))],
      [new Map([[new UOp(Ops.CONST, dtypes.int, [], 0), [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)]], [new UOp(Ops.CONST, dtypes.int, [], 10), [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)]], [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)]], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)]], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)]], [new UOp(Ops.CONST, dtypes.float, [], 0.0), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)]], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined), [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)], new KernelInfo(0, 0, false))]]]), new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], new BasicBlock([], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0), new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined), new UOp(Ops.ENDRANGE, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)], undefined))],
      [new Map([[new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.CONST, dtypes.int, [], 0), [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)]], [new UOp(Ops.CONST, dtypes.float, [], 1.0), [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)]], [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), [new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)]], [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)]], [new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)]], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined), [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)], new KernelInfo(0, 0, false))]]]), new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.float, [], 1.0)], new BasicBlock([], [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined), new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined), new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)], new KernelInfo(0, 0, false))], undefined))],
      [new Map([[new UOp(Ops.CONST, dtypes.int, [], 0), [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)]], [new UOp(Ops.CONST, dtypes.int, [], 10), [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)]], [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)]], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)]], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)]], [new UOp(Ops.CONST, dtypes.float, [], 0.0), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)]], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined), [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)], new KernelInfo(0, 0, false))]]]), new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], new BasicBlock([new UOp(Ops.BLOCKSTART, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined))], new BasicBlock([new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)], undefined))],
      [new Map([[new UOp(Ops.CONST, dtypes.int, [], 0), [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)]], [new UOp(Ops.CONST, dtypes.int, [], 10), [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)]], [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)]], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)]], [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)]], [new UOp(Ops.CONST, dtypes.float, [], 0.0), [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)]], [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined), [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)], new KernelInfo(0, 0, false))]]]), new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], new BasicBlock([], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0), new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined), new UOp(Ops.ENDRANGE, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)], new KernelInfo(0, 0, false))], undefined))],
    ],
    block_merge,
    'out(tiny.codegen.linearize.block_merge(*data))',
  ),
)
Deno.test(
  'block_reorder',
  compare(
    [
      [new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.float, [], 0.0)], new BasicBlock([], [new UOp(Ops.VECTORIZE, dtypes.float.vec(4), [new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)], undefined))],
      [new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 8)], new BasicBlock([new UOp(Ops.BLOCKSTART, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 8)], 0)], undefined)], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 8)], 0)], undefined))],
      [new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 16)], new BasicBlock([new UOp(Ops.BLOCKSTART, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 16)], 0)], undefined)], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 16)], 0)], undefined))],
      [new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], new BasicBlock([new UOp(Ops.BLOCKSTART, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined)], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined))],
      [new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], new BasicBlock([new UOp(Ops.BLOCKSTART, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0)], undefined)], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0)], undefined))],
      [new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 6400)], new BasicBlock([new UOp(Ops.BLOCKSTART, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 6400)], 0)], undefined)], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 6400)], 0)], undefined))],
      [new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.float, [], 0)], new BasicBlock([], [new UOp(Ops.VECTORIZE, dtypes.float.vec(4), [new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0)], undefined)], undefined))],
      [new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], new BasicBlock([new UOp(Ops.BLOCKSTART, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0)], undefined)], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0)], undefined))],
      [new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.float, [], 0)], new BasicBlock([], [new UOp(Ops.VECTORIZE, dtypes.float.vec(4), [new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0)], undefined)], undefined)), new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 2), new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], new BasicBlock([new UOp(Ops.BLOCKSTART, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0)], undefined)], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0)], undefined))], new BasicBlock([new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0)], [new UOp(Ops.SHL, dtypes.int, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0), new UOp(Ops.CONST, dtypes.int, [], 2)], undefined), new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.SHL, dtypes.int, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0), new UOp(Ops.CONST, dtypes.int, [], 2)], undefined)], undefined), new UOp(Ops.CAST, dtypes.float.vec(4).ptr(), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.SHL, dtypes.int, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0), new UOp(Ops.CONST, dtypes.int, [], 2)], undefined)], undefined)], undefined), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.CAST, dtypes.float.vec(4).ptr(), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.SHL, dtypes.int, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0), new UOp(Ops.CONST, dtypes.int, [], 2)], undefined)], undefined)], undefined), new UOp(Ops.VECTORIZE, dtypes.float.vec(4), [new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0)], undefined)], undefined)], undefined))],
      [new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.BLOCKEND, dtypes.void, [new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.float, [], 0)], new BasicBlock([], [new UOp(Ops.VECTORIZE, dtypes.float.vec(4), [new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0)], undefined)], undefined)), new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 2), new UOp(Ops.BLOCK, dtypes.void, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], new BasicBlock([new UOp(Ops.BLOCKSTART, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0)], undefined)], [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0)], undefined))], new BasicBlock([new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0)], [new UOp(Ops.SHL, dtypes.int, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0), new UOp(Ops.CONST, dtypes.int, [], 2)], undefined), new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.SHL, dtypes.int, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0), new UOp(Ops.CONST, dtypes.int, [], 2)], undefined)], undefined), new UOp(Ops.CAST, dtypes.float.vec(4).ptr(), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.SHL, dtypes.int, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0), new UOp(Ops.CONST, dtypes.int, [], 2)], undefined)], undefined)], undefined), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.CAST, dtypes.float.vec(4).ptr(), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.SHL, dtypes.int, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0), new UOp(Ops.CONST, dtypes.int, [], 2)], undefined)], undefined)], undefined), new UOp(Ops.VECTORIZE, dtypes.float.vec(4), [new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0)], undefined)], undefined)], undefined))], new BasicBlock([], [new UOp(Ops.ENDRANGE, dtypes.void, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0)], undefined)], new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0)))], new BasicBlock([], [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.CAST, dtypes.float.vec(4).ptr(), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.SHL, dtypes.int, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0), new UOp(Ops.CONST, dtypes.int, [], 2)], undefined)], undefined)], undefined), new UOp(Ops.VECTORIZE, dtypes.float.vec(4), [new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0), new UOp(Ops.CONST, dtypes.float, [], 0)], undefined)], undefined)], new KernelInfo(0, 1, false))], undefined))],
    ],
    block_reorder,
    'out(tiny.codegen.linearize.block_reorder(*data))',
  ),
)
Deno.test(
  'linearize_uop',
  compare(
    [
      [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new KernelInfo(0, 0, false)), true],
      [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 10)], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)], new KernelInfo(0, 0, false)), true],
      // For some reason order fails
      // [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.uint.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.uint.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.BITCAST, dtypes.uint, [new UOp(Ops.NOOP, dtypes.float, [new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], undefined)], undefined)], new KernelInfo(0, 0, false)), false],
      [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.CAST, dtypes.float.vec(4).ptr(), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.SHL, dtypes.int, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 8)], 0), new UOp(Ops.CONST, dtypes.int, [], 2)], undefined)], undefined)], undefined), new UOp(Ops.VECTORIZE, dtypes.float.vec(4), [new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)], undefined)], new KernelInfo(0, 1, false)), true],
      [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.CAST, dtypes.float.vec(4).ptr(), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.SHL, dtypes.int, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 16)], 0), new UOp(Ops.CONST, dtypes.int, [], 2)], undefined)], undefined)], undefined), new UOp(Ops.VECTORIZE, dtypes.float.vec(4), [new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)], undefined)], new KernelInfo(0, 1, false)), true],
      [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.CAST, dtypes.float.vec(4).ptr(), [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.SHL, dtypes.int, [new UOp(Ops.RANGE, dtypes.int, [new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 200)], 0), new UOp(Ops.CONST, dtypes.int, [], 2)], undefined)], undefined)], undefined), new UOp(Ops.VECTORIZE, dtypes.float.vec(4), [new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.float, [], 0.0), new UOp(Ops.CONST, dtypes.float, [], 0.0)], undefined)], undefined)], new KernelInfo(0, 1, false)), true],
      [new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.INDEX, dtypes.float.ptr(), [new UOp(Ops.DEFINE_GLOBAL, dtypes.float.ptr(), [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined), new UOp(Ops.CONST, dtypes.float, [], 1.0)], undefined)], new KernelInfo(0, 0, false)), false],
    ],
    linearize_uop,
    'out(trycatch(lambda:tiny.codegen.linearize.linearize_uop(*data)))',
  ),
)

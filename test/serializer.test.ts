// deno-fmt-ignore-file

import {  Opt, OptOps } from '../src/codegen/kernel.ts'
import { IndexContext } from '../src/codegen/lowerer.ts'
import { BasicBlock } from '../src/codegen/linearize.ts'
import { dtypes,DType,PtrDType } from '../src/dtype.ts'
import { Ops, spec, UOp, UPat,KernelInfo } from '../src/ops.ts'
import { ClangRenderer } from '../src/renderer/cstyle.ts'
import { ShapeTracker } from '../src/shape/shapetracker.ts'
import { View } from '../src/shape/view.ts'
import { compare } from './helpers.ts'

Deno.test(
  'serialize',
  compare(
    [
      [new View({ shape:[10, 576], strides:[576, 1], offset:0, mask:undefined, contiguous:true }),],
      [[4, 4, 'sdf', { sdf: 69 }, [{ df: 44, sdf: 'sdf' }]]],
      [Ops.ADD],
      [Ops.ASSIGN],
      [new UOp({ op: Ops.BARRIER, dtype: dtypes.float, arg: 5445 })],
      [new UPat({ op: Ops.ASSIGN, dtype: dtypes.floats, arg: 555, name: 'sdf' })],
      [new UPat({ op: Ops.IF, name: 'conditional_op', dtype: dtypes.bool, src: [new UPat({ op: Ops.CMPLT, name: 'cmp_op', dtype: dtypes.bool }), new UPat({ name: 'true_case' }), new UPat({ name: 'false_case' })] })],
      [dtypes.floats],
      [dtypes.default_int],
      [dtypes.imagef(2, 44, 42)],
      [dtypes.bool.ptr(true)],
      [dtypes.bool.ptr(false)],
      [
        new View({
          shape: [4, 55],
          strides: [new UOp({ op: Ops.MUL, dtype: dtypes.int, arg: undefined, src: [new UOp({ op: Ops.CONST, dtype: dtypes.int, arg: 1, src: [] }), new UOp({ op: Ops.CONST, dtype: dtypes.int, arg: 55, src: [] })] }), 1],
          offset: 0,
          mask: undefined,
          contiguous: false,
        }),
      ],
      [ShapeTracker.from_shape([UOp.float(8), UOp.int(110), UOp.int(33)])],
      [new IndexContext([UOp.int(3)], [UOp.bool(true), UOp.float(4.4)], 4)],
      [new ClangRenderer()],
      [new Opt(OptOps.PADTO, 5, 666)],
      // [new Kernel(new UOp({ op: Ops.SINK }), new ClangRenderer())],
      // [new Kernel(new UOp({ op: Ops.SINK }))],
      ...spec.patterns.map((p) => [p[0]] as any),
      [[[new Map([[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), []], [new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 }), []], [new UOp({ op:35, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 })], arg:undefined }), []], [new UOp({ op:62, dtype:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), src:[], arg:1.0 }), []], [new UOp({ op:34, dtype:new DType({ priority:-1, itemsize:0, name:`void`, fmt:undefined, count:1, _scalar:undefined }), src:[new UOp({ op:35, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 })], arg:undefined }), new UOp({ op:62, dtype:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), src:[], arg:1.0 })], arg:undefined }), []], [new UOp({ op:1, dtype:new DType({ priority:-1, itemsize:0, name:`void`, fmt:undefined, count:1, _scalar:undefined }), src:[new UOp({ op:34, dtype:new DType({ priority:-1, itemsize:0, name:`void`, fmt:undefined, count:1, _scalar:undefined }), src:[new UOp({ op:35, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 })], arg:undefined }), new UOp({ op:62, dtype:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), src:[], arg:1.0 })], arg:undefined })], arg:new KernelInfo(0, 0, false) }), []]]), new Map([[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), [new UOp({ op:35, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 })], arg:undefined })]], [new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 }), [new UOp({ op:35, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 })], arg:undefined })]], [new UOp({ op:35, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 })], arg:undefined }), [new UOp({ op:34, dtype:new DType({ priority:-1, itemsize:0, name:`void`, fmt:undefined, count:1, _scalar:undefined }), src:[new UOp({ op:35, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 })], arg:undefined }), new UOp({ op:62, dtype:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), src:[], arg:1.0 })], arg:undefined })]], [new UOp({ op:62, dtype:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), src:[], arg:1.0 }), [new UOp({ op:34, dtype:new DType({ priority:-1, itemsize:0, name:`void`, fmt:undefined, count:1, _scalar:undefined }), src:[new UOp({ op:35, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 })], arg:undefined }), new UOp({ op:62, dtype:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), src:[], arg:1.0 })], arg:undefined })]], [new UOp({ op:34, dtype:new DType({ priority:-1, itemsize:0, name:`void`, fmt:undefined, count:1, _scalar:undefined }), src:[new UOp({ op:35, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 })], arg:undefined }), new UOp({ op:62, dtype:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), src:[], arg:1.0 })], arg:undefined }), [new UOp({ op:1, dtype:new DType({ priority:-1, itemsize:0, name:`void`, fmt:undefined, count:1, _scalar:undefined }), src:[new UOp({ op:34, dtype:new DType({ priority:-1, itemsize:0, name:`void`, fmt:undefined, count:1, _scalar:undefined }), src:[new UOp({ op:35, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 })], arg:undefined }), new UOp({ op:62, dtype:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), src:[], arg:1.0 })], arg:undefined })], arg:new KernelInfo(0, 0, false) })]]])], new UOp({ op:7, dtype:new DType({ priority:-1, itemsize:0, name:`void`, fmt:undefined, count:1, _scalar:undefined }), src:[new UOp({ op:34, dtype:new DType({ priority:-1, itemsize:0, name:`void`, fmt:undefined, count:1, _scalar:undefined }), src:[new UOp({ op:35, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 })], arg:undefined }), new UOp({ op:62, dtype:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), src:[], arg:1.0 })], arg:undefined })], arg:new BasicBlock([], [new UOp({ op:1, dtype:new DType({ priority:-1, itemsize:0, name:`void`, fmt:undefined, count:1, _scalar:undefined }), src:[new UOp({ op:34, dtype:new DType({ priority:-1, itemsize:0, name:`void`, fmt:undefined, count:1, _scalar:undefined }), src:[new UOp({ op:35, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[new UOp({ op:14, dtype:new PtrDType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined, _base:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), local:false, v:1 }), src:[], arg:0 }), new UOp({ op:62, dtype:new DType({ priority:5, itemsize:4, name:`int`, fmt:`i`, count:1, _scalar:undefined }), src:[], arg:0 })], arg:undefined }), new UOp({ op:62, dtype:new DType({ priority:11, itemsize:4, name:`float`, fmt:`f`, count:1, _scalar:undefined }), src:[], arg:1.0 })], arg:undefined })], arg:new KernelInfo(0, 0, false) })], undefined) })]]

    ],
    (x) => x,
    'out(*data)',

  ),
)

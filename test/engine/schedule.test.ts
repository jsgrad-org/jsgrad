import { Buffer } from '../../src/device.ts'
import { DType, dtypes, PtrDType } from '../../src/dtype.ts'
import { LazyBuffer } from '../../src/engine/lazy.ts'
import { _append_st_vars, apply_swizzle, create_schedule_with_vars, full_ast_rewrite, init_big_graph, push_swizzle_down_through_elementwise, realize_view, recursive_group, ScheduleContext, ScheduleItemContext, to_uop } from '../../src/engine/schedule.ts'
import { counter, Metadata } from '../../src/helpers.ts'
import { Ops, UOp } from '../../src/ops.ts'
import { ShapeTracker } from '../../src/shape/shapetracker.ts'
import { View } from '../../src/shape/view.ts'
import { compare } from '../helpers.ts'

Deno.test(
  'schedule.to_uop',
  compare(
    [
      [new LazyBuffer(`CLANG`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.COPY, 8, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([8], [1], 107744, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false)), new ScheduleContext(new Map([]), new Map([]), new Set([]), new Map([]), new Map([]), new Map([]), new Map([])), new Map<UOp, Buffer>([]), new Map<LazyBuffer, UOp>([])],
      [new LazyBuffer(`CLANG`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.COPY, 8, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([8], [1], 330216, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false)), new ScheduleContext(new Map([]), new Map([]), new Set([]), new Map([]), new Map([]), new Map([]), new Map([])), new Map<UOp, Buffer>([]), new Map<LazyBuffer, UOp>([])],
      [new LazyBuffer(`CLANG`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.float, Ops.COPY, 40, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([40], [1], 353776, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false)), new ScheduleContext(new Map([]), new Map([]), new Set([]), new Map([]), new Map([]), new Map([]), new Map([])), new Map<UOp, Buffer>([]), new Map<LazyBuffer, UOp>([])],
      [new LazyBuffer(`CLANG`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.COPY, 128, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 4832, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false)), new ScheduleContext(new Map([]), new Map([]), new Set([]), new Map([]), new Map([]), new Map([]), new Map([])), new Map<UOp, Buffer>([]), new Map<LazyBuffer, UOp>([])],
      [new LazyBuffer(`CLANG`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.COPY, 128, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 107488, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false)), new ScheduleContext(new Map([]), new Map([]), new Set([]), new Map([]), new Map([]), new Map([]), new Map([])), new Map<UOp, Buffer>([]), new Map<LazyBuffer, UOp>([])],
      [new LazyBuffer(`CLANG`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.COPY, 128, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 107616, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false)), new ScheduleContext(new Map([]), new Map([]), new Set([]), new Map([]), new Map([]), new Map([]), new Map([])), new Map<UOp, Buffer>([]), new Map<LazyBuffer, UOp>([])],
    ],
    (buf: LazyBuffer, ctx: ScheduleContext, buffers: Map<UOp, Buffer>, cache: Map<LazyBuffer, UOp>) => {
      UOp.buffer_num = counter(0) //resetting counter
      return to_uop(buf, ctx, buffers, cache)
    },
    'out(tiny.engine.schedule.to_uop(*data))',
  ),
)

Deno.test(
  'apply_swizzle',
  compare(
    [
      [new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([10], [1], 0, undefined, true)])), new ShapeTracker([new View([1, 10], [0, 1], 0, undefined, true)])],
      [new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([10], [1], 0, undefined, true)])), new ShapeTracker([new View([10, 1], [1, 0], 0, undefined, true)])],
      [new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([256], [1], 0, undefined, true)])), new ShapeTracker([new View([256, 1], [1, 0], 0, undefined, true)])],
      [new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([60000], [1], 0, undefined, true)])), new ShapeTracker([new View([60000, 1], [1, 0], 0, undefined, true)])],
      [new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([64], [1], 0, undefined, true)])), new ShapeTracker([new View([1, 64, 1, 1], [0, 1, 0, 0], 0, undefined, true)])],
      [new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([512, 1], [1, 0], 0, undefined, true)])), new ShapeTracker([new View([512, 1, 1], [1, 0, 0], 0, undefined, true)])],
    ],
    apply_swizzle,
    'out(tiny.engine.schedule.apply_swizzle(*data))',
  ),
)

Deno.test(
  'push_swizzle_down_through_elementwise',
  compare(
    [
      [new UOp(Ops.WHERE, dtypes.int, [new UOp(Ops.VALID, dtypes.bool, [new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([10], [0], 0, undefined, false)]))], undefined), new UOp(Ops.CONST, dtypes.int, [], -1), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)],
      [new UOp(Ops.WHERE, dtypes.int, [new UOp(Ops.VALID, dtypes.bool, [new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([512], [0], 0, undefined, false)]))], undefined), new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)],
      [new UOp(Ops.WHERE, dtypes.long, [new UOp(Ops.VALID, dtypes.bool, [new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], undefined), new UOp(Ops.CONST, dtypes.long, [], 1), new UOp(Ops.CONST, dtypes.long, [], 0)], undefined)],
      [new UOp(Ops.WHERE, dtypes.int, [new UOp(Ops.VALID, dtypes.bool, [new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([60000], [0], 0, undefined, false)]))], undefined), new UOp(Ops.CONST, dtypes.int, [], -1), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)],
      [new UOp(Ops.WHERE, dtypes.int, [new UOp(Ops.VALID, dtypes.bool, [new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([512], [0], 0, undefined, false)]))], undefined), new UOp(Ops.CONST, dtypes.int, [], 60000), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)],
      [new UOp(Ops.WHERE, dtypes.int, [new UOp(Ops.VALID, dtypes.bool, [new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([10, 1], [0, 0], 0, undefined, false)]))], undefined), new UOp(Ops.CONST, dtypes.int, [], -1), new UOp(Ops.CONST, dtypes.int, [], 0)], undefined)],
    ],
    push_swizzle_down_through_elementwise,
    'out(tiny.engine.schedule.push_swizzle_down_through_elementwise(*data))',
  ),
)

Deno.test(
  '_append_st_vars',
  compare(
    [
      [new ScheduleItemContext(new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([8], [1], 107744, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [24, [`CLANG`, 1, dtypes.long]]), new LazyBuffer(`CLANG`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.COPY, 8, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([8], [1], 107744, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false))]]), new Map([[new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [26, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([8], [1], 107744, undefined, false)]))], undefined), new Metadata(`bitcast`, ``, false)], [new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.LOAD, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], undefined)], 8), new Metadata(`to`, ``, false)]]), new Set([]), new Map([]), new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [24, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.LOAD, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], undefined)], 8)]]), new Set([]), [], new Set([new Metadata(`to`, ``, false)]), new Map([])), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)]))],
      [new ScheduleItemContext(new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([8], [1], 330216, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [51, [`CLANG`, 1, dtypes.long]]), new LazyBuffer(`CLANG`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.COPY, 8, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([8], [1], 330216, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false))]]), new Map([[new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [53, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([8], [1], 330216, undefined, false)]))], undefined), new Metadata(`bitcast`, ``, false)], [new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.LOAD, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], undefined)], 8), new Metadata(`to`, ``, false)]]), new Set([]), new Map([]), new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [51, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.LOAD, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], undefined)], 8)]]), new Set([]), [], new Set([new Metadata(`to`, ``, false)]), new Map([])), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)]))],
      [new ScheduleItemContext(new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 4832, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [9, [`CLANG`, 32, dtypes.float]]), new LazyBuffer(`CLANG`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.COPY, 128, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 4832, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false))]]), new Map([[new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [11, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([128], [1], 4832, undefined, false)]))], undefined), new Metadata(`bitcast`, ``, false)], [new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128), new Metadata(`to`, ``, false)]]), new Set([]), new Map([]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [9, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128)]]), new Set([]), [], new Set([new Metadata(`to`, ``, false)]), new Map([])), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))],
      [new ScheduleItemContext(new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([40], [1], 353776, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [63, [`CLANG`, 10, dtypes.float]]), new LazyBuffer(`CLANG`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.float, Ops.COPY, 40, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([40], [1], 353776, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false))]]), new Map([[new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [65, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([40], [1], 353776, undefined, false)]))], undefined), new Metadata(`bitcast`, ``, false)], [new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([10], [1], 0, undefined, true)]))], undefined)], 40), new Metadata(`to`, ``, false)]]), new Set([]), new Map([]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [63, [`CLANG`, 10, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([10], [1], 0, undefined, true)]))], undefined)], 40)]]), new Set([]), [], new Set([new Metadata(`to`, ``, false)]), new Map([])), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([10], [1], 0, undefined, true)]))],
      [new ScheduleItemContext(new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [28, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 107752, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [27, [`CLANG`, 32, dtypes.float]]), new LazyBuffer(`CLANG`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.COPY, 128, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 107752, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false))]]), new Map([[new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [29, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([128], [1], 107752, undefined, false)]))], undefined), new Metadata(`bitcast`, ``, false)], [new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [28, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128), new Metadata(`to`, ``, false)]]), new Set([]), new Map([]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [27, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [28, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128)]]), new Set([]), [], new Set([new Metadata(`to`, ``, false)]), new Map([])), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))],
      [new ScheduleItemContext(new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [19, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 107488, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [18, [`CLANG`, 32, dtypes.float]]), new LazyBuffer(`CLANG`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.COPY, 128, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 107488, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false))]]), new Map([[new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [20, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([128], [1], 107488, undefined, false)]))], undefined), new Metadata(`bitcast`, ``, false)], [new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [19, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128), new Metadata(`to`, ``, false)]]), new Set([]), new Map([]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [18, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [19, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128)]]), new Set([]), [], new Set([new Metadata(`to`, ``, false)]), new Map([])), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))],
    ],
    _append_st_vars,
    'out(tiny.engine.schedule._append_st_vars(*data))',
  ),
)

Deno.test(
  'full_ast_rewrite',
  compare(
    [
      [
        new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [24, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)])), new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.LOAD, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], undefined)], 8)], undefined)], undefined),
        new ScheduleContext(new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([8], [1], 107744, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [24, [`CLANG`, 1, dtypes.long]]), new LazyBuffer(`CLANG`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.COPY, 8, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([8], [1], 107744, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false))]]), new Map([]), new Set([]), new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [24, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [24, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)])), new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.LOAD, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], undefined)], 8)], undefined)], [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)])), new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [26, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([8], [1], 107744, undefined, false)]))], undefined)], undefined)]]), new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [26, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([8], [1], 107744, undefined, false)]))], undefined)], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [24, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [24, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.VIEW, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [26, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([8], [1], 107744, undefined, false)]))], undefined)], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], 8)], new ShapeTracker([new View([1], [0], 0, undefined, true)]))]]), new Map([[new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [26, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([8], [1], 107744, undefined, false)]))], undefined), new Metadata(`bitcast`, ``, false)], [new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.LOAD, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], undefined)], 8), new Metadata(`to`, ``, false)]]), new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [24, [`CLANG`, 1, dtypes.long]]), undefined]])]])),
      ],
      [
        new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [51, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)])), new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.LOAD, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], undefined)], 8)], undefined)], undefined),
        new ScheduleContext(new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([8], [1], 330216, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [51, [`CLANG`, 1, dtypes.long]]), new LazyBuffer(`CLANG`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.COPY, 8, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([1], [0], 0, undefined, true)]), dtypes.long, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([8], [1], 330216, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false))]]), new Map([]), new Set([]), new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [51, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [51, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)])), new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.LOAD, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], undefined)], 8)], undefined)], [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)])), new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [53, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([8], [1], 330216, undefined, false)]))], undefined)], undefined)]]), new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [53, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([8], [1], 330216, undefined, false)]))], undefined)], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [51, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [51, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.VIEW, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [53, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([8], [1], 330216, undefined, false)]))], undefined)], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], 8)], new ShapeTracker([new View([1], [0], 0, undefined, true)]))]]), new Map([[new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [53, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([8], [1], 330216, undefined, false)]))], undefined), new Metadata(`bitcast`, ``, false)], [new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.LOAD, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], undefined)], 8), new Metadata(`to`, ``, false)]]), new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [51, [`CLANG`, 1, dtypes.long]]), undefined]])]])),
      ],
      [
        new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [9, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)])), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128)], undefined)], undefined),
        new ScheduleContext(new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 4832, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [9, [`CLANG`, 32, dtypes.float]]), new LazyBuffer(`CLANG`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.COPY, 128, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 4832, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false))]]), new Map([]), new Set([]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [9, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [9, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)])), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128)], undefined)], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)])), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [11, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([128], [1], 4832, undefined, false)]))], undefined)], undefined)]]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [11, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([128], [1], 4832, undefined, false)]))], undefined)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [9, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [9, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [11, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([128], [1], 4832, undefined, false)]))], undefined)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], 128)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))]]), new Map([[new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [11, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([128], [1], 4832, undefined, false)]))], undefined), new Metadata(`bitcast`, ``, false)], [new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128), new Metadata(`to`, ``, false)]]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [9, [`CLANG`, 32, dtypes.float]]), undefined]])]])),
      ],
      [
        new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [63, [`CLANG`, 10, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([10], [1], 0, undefined, true)])), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([10], [1], 0, undefined, true)]))], undefined)], 40)], undefined)], undefined),
        new ScheduleContext(new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([40], [1], 353776, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [63, [`CLANG`, 10, dtypes.float]]), new LazyBuffer(`CLANG`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.float, Ops.COPY, 40, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([40], [1], 353776, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false))]]), new Map([]), new Set([]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [63, [`CLANG`, 10, dtypes.float]]), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [63, [`CLANG`, 10, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([10], [1], 0, undefined, true)])), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([10], [1], 0, undefined, true)]))], undefined)], 40)], undefined)], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([10], [1], 0, undefined, true)])), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [65, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([40], [1], 353776, undefined, false)]))], undefined)], undefined)]]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [65, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([40], [1], 353776, undefined, false)]))], undefined)], new ShapeTracker([new View([10], [1], 0, undefined, true)]))], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [63, [`CLANG`, 10, dtypes.float]]), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [63, [`CLANG`, 10, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [65, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([40], [1], 353776, undefined, false)]))], undefined)], new ShapeTracker([new View([10], [1], 0, undefined, true)]))], 40)], new ShapeTracker([new View([10], [1], 0, undefined, true)]))]]), new Map([[new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [65, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([40], [1], 353776, undefined, false)]))], undefined), new Metadata(`bitcast`, ``, false)], [new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([10], [1], 0, undefined, true)]))], undefined)], 40), new Metadata(`to`, ``, false)]]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [63, [`CLANG`, 10, dtypes.float]]), undefined]])]])),
      ],
      [
        new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [15, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)])), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [16, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128)], undefined)], undefined),
        new ScheduleContext(new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [16, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 107360, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [15, [`CLANG`, 32, dtypes.float]]), new LazyBuffer(`CLANG`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.COPY, 128, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 107360, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false))]]), new Map([]), new Set([]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [15, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [15, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)])), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [16, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128)], undefined)], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [16, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [16, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)])), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [17, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([128], [1], 107360, undefined, false)]))], undefined)], undefined)]]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [16, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [16, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [17, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([128], [1], 107360, undefined, false)]))], undefined)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [15, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [15, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [16, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [17, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([128], [1], 107360, undefined, false)]))], undefined)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], 128)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))]]), new Map([[new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [17, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([128], [1], 107360, undefined, false)]))], undefined), new Metadata(`bitcast`, ``, false)], [new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [16, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128), new Metadata(`to`, ``, false)]]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [16, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [15, [`CLANG`, 32, dtypes.float]]), undefined]])]])),
      ],
      [
        new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [21, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)])), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [22, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128)], undefined)], undefined),
        new ScheduleContext(new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [22, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 107616, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [21, [`CLANG`, 32, dtypes.float]]), new LazyBuffer(`CLANG`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.COPY, 128, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([32], [1], 0, undefined, true)]), dtypes.float, Ops.BUFFER_VIEW, undefined, [new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([128], [1], 107616, undefined, false)]), dtypes.uchar, undefined, undefined, [], new LazyBuffer(`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, new ShapeTracker([new View([353816], [1], 0, undefined, true)]), dtypes.uchar, Ops.EMPTY, undefined, [], undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`bitcast`, ``, false))], undefined, new Metadata(`to`, ``, false))]]), new Map([]), new Set([]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [21, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [21, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)])), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [22, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128)], undefined)], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [22, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.STORE, dtypes.void, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [22, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)])), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [23, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([128], [1], 107616, undefined, false)]))], undefined)], undefined)]]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [22, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [22, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [23, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([128], [1], 107616, undefined, false)]))], undefined)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [21, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [21, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [22, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [23, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([128], [1], 107616, undefined, false)]))], undefined)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], 128)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))]]), new Map([[new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.LOAD, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [23, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], undefined)], new ShapeTracker([new View([128], [1], 107616, undefined, false)]))], undefined), new Metadata(`bitcast`, ``, false)], [new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.LOAD, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [22, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.VIEW, dtypes.void, [], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)], 128), new Metadata(`to`, ``, false)]]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [22, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [21, [`CLANG`, 32, dtypes.float]]), undefined]])]])),
      ],
    ],
    (pre: UOp, ctx: ScheduleContext) => {
      return full_ast_rewrite(pre, ctx)
    },
    'out(tiny.engine.schedule.full_ast_rewrite(*data))',
  ),
)

Deno.test.ignore(
  'recursive_group',
  compare(
    [
      [new UOp(Ops.BUFFER), new ShapeTracker([new View([10], [1], 0)]), new UOp(Ops.BUFFER), new Map([[new UOp(Ops.BUFFER), new Map()]]), new Map([[new UOp(Ops.BUFFER), new UOp(Ops.BUFFER, undefined, undefined, new ShapeTracker([new View([10], [1], 0)]))]]), new Map(), new Map(), new Map(), new Map()],
      [new UOp(Ops.BUFFER), new ShapeTracker([new View([10], [1], 0)]), new UOp(Ops.BUFFER), new Map([[new UOp(Ops.BUFFER), new Map()]]), new Map([[new UOp(Ops.BUFFER), new UOp(Ops.BUFFER, undefined, undefined, new ShapeTracker([new View([10], [1], 0)]))]]), new Map([[new UOp(Ops.BUFFER), new UOp(Ops.BUFFER)]]), new Map(), new Map(), new Map()],
      [new UOp(Ops.BUFFER), new ShapeTracker([new View([10], [2], 0)]), new UOp(Ops.BUFFER), new Map([[new UOp(Ops.BUFFER), new Map()]]), new Map([[new UOp(Ops.BUFFER), new UOp(Ops.BUFFER, undefined, undefined, new ShapeTracker([new View([10], [1], 0)]))]]), new Map([[new UOp(Ops.BUFFER), new UOp(Ops.BUFFER)]]), new Map(), new Map(), new Map()],
    ],
    recursive_group,
    'out(tiny.engine.schedule.recursive_group(*data))',
  ),
)

// Deno.test(
//   'get_isolated_children',
//   compare(
//     [

//     ],
//     get_isolated_children,
//     'out(tiny.engine.schedule.get_isolated_children(*data))',
//   ),
// )

// Deno.test(
//   'group_realizes',
//   compare(
//     [],
//     () => {},
//     'out(XXX)',
//   ),
// )

// Deno.test(
//   '_as_const',
//   compare(
//     [],
//     () => {},
//     'out(XXX)',
//   ),
// )

Deno.test(
  'realize_view',
  compare(
    [
      [new Map(), new UOp(Ops.VIEW, dtypes.int, [new UOp(Ops.BUFFER, dtypes.int.ptr(), [], [83, [`CLANG`, 1, dtypes.int]]), new UOp(Ops.CONST, dtypes.int, [], 0)], new ShapeTracker([new View([], [], 0)])), new UOp(Ops.VIEW, dtypes.int, [new UOp(Ops.VIEW, dtypes.int, [new UOp(Ops.BUFFER, dtypes.int.ptr(), [], [83, [`CLANG`, 1, dtypes.int]]), new UOp(Ops.CONST, dtypes.int, [], 0)], new ShapeTracker([new View([], [], 0)]))], new ShapeTracker([new View([512], [0], 0)])), new UOp(Ops.CONST, dtypes.int, [], 0), new UOp(Ops.BUFFER, dtypes.int.ptr(), [], [83, [`CLANG`, 1, dtypes.int]])],
      [new Map(), new UOp(Ops.VIEW, dtypes.int, [new UOp(Ops.BUFFER, dtypes.int.ptr(), [], [88, [`CLANG`, 1, dtypes.int]]), new UOp(Ops.CONST, dtypes.int, [], -1)], new ShapeTracker([new View([], [], 0)])), new UOp(Ops.VIEW, dtypes.int, [new UOp(Ops.VIEW, dtypes.int, [new UOp(Ops.BUFFER, dtypes.int.ptr(), [], [88, [`CLANG`, 1, dtypes.int]]), new UOp(Ops.CONST, dtypes.int, [], -1)], new ShapeTracker([new View([], [], 0)]))], new ShapeTracker([new View([60000], [0], 0)])), new UOp(Ops.CONST, dtypes.int, [], -1), new UOp(Ops.BUFFER, dtypes.int.ptr(), [], [88, [`CLANG`, 1, dtypes.int]])],
      [new Map(), new UOp(Ops.VIEW, dtypes.int, [new UOp(Ops.BUFFER, dtypes.int.ptr(), [], [84, [`CLANG`, 1, dtypes.int]]), new UOp(Ops.CONST, dtypes.int, [], 60000)], new ShapeTracker([new View([], [], 0)])), new UOp(Ops.VIEW, dtypes.int, [new UOp(Ops.VIEW, dtypes.int, [new UOp(Ops.BUFFER, dtypes.int.ptr(), [], [84, [`CLANG`, 1, dtypes.int]]), new UOp(Ops.CONST, dtypes.int, [], 60000)], new ShapeTracker([new View([], [], 0)]))], new ShapeTracker([new View([512], [0], 0)])), new UOp(Ops.CONST, dtypes.int, [], 60000), new UOp(Ops.BUFFER, dtypes.int.ptr(), [], [84, [`CLANG`, 1, dtypes.int]])],
      [new Map(), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [3, [`CLANG`, 1, dtypes.float]]), new UOp(Ops.CONST, dtypes.float, [], 0.9)], new ShapeTracker([new View([], [], 0)])), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [3, [`CLANG`, 1, dtypes.float]]), new UOp(Ops.CONST, dtypes.float, [], 0.9)], new ShapeTracker([new View([], [], 0)]))], new ShapeTracker([new View([1], [0], 0)])), new UOp(Ops.CONST, dtypes.float, [], 0.9), new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [3, [`CLANG`, 1, dtypes.float]])],
      [new Map(), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [2, [`CLANG`, 1, dtypes.float]]), new UOp(Ops.CONST, dtypes.float, [], 1.0)], new ShapeTracker([new View([], [], 0)])), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [2, [`CLANG`, 1, dtypes.float]]), new UOp(Ops.CONST, dtypes.float, [], 1.0)], new ShapeTracker([new View([], [], 0)]))], new ShapeTracker([new View([1], [0], 0)])), new UOp(Ops.CONST, dtypes.float, [], 1.0), new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [2, [`CLANG`, 1, dtypes.float]])],
      [new Map(), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [99, [`CLANG`, 1, dtypes.float]]), new UOp(Ops.CONST, dtypes.float, [], 0.4)], new ShapeTracker([new View([], [], 0)])), new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [99, [`CLANG`, 1, dtypes.float]]), new UOp(Ops.CONST, dtypes.float, [], 0.4)], new ShapeTracker([new View([], [], 0)]))], new ShapeTracker([new View([32], [0], 0)])), new UOp(Ops.CONST, dtypes.float, [], 0.4), new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [99, [`CLANG`, 1, dtypes.float]])],
    ],
    realize_view,
    'out(tiny.engine.schedule.realize_view(*data))',
  ),
)

Deno.test(
  'init_big_graph',
  compare(
    [
      [new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [51, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.VIEW, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [53, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([8], [1], 330216, undefined, false)]))], undefined)], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], 8)], [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [53, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([8], [1], 330216, undefined, false)]))], undefined)]]), new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.VIEW, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [51, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.VIEW, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [52, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [53, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([8], [1], 330216, undefined, false)]))], undefined)], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], 8)], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], undefined)],
      [new Map([[new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [24, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.VIEW, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [26, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([8], [1], 107744, undefined, false)]))], undefined)], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], 8)], [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [26, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([8], [1], 107744, undefined, false)]))], undefined)]]), new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.VIEW, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [24, [`CLANG`, 1, dtypes.long]]), new UOp(Ops.COPY, dtypes.long, [new UOp(Ops.VIEW, dtypes.long, [new UOp(Ops.BUFFER, dtypes.long.ptr(), [], [25, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 1, dtypes.long]]), new UOp(Ops.BUFFER_VIEW, dtypes.long, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [26, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([8], [1], 107744, undefined, false)]))], undefined)], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], 8)], new ShapeTracker([new View([1], [0], 0, undefined, true)]))], undefined)],
      [new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [9, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [11, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([128], [1], 4832, undefined, false)]))], undefined)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], 128)], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [11, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([128], [1], 4832, undefined, false)]))], undefined)]]), new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [9, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [10, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [11, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([128], [1], 4832, undefined, false)]))], undefined)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], 128)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)],
      [new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [63, [`CLANG`, 10, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [65, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([40], [1], 353776, undefined, false)]))], undefined)], new ShapeTracker([new View([10], [1], 0, undefined, true)]))], 40)], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [65, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([40], [1], 353776, undefined, false)]))], undefined)]]), new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [63, [`CLANG`, 10, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [64, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 10, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [65, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([40], [1], 353776, undefined, false)]))], undefined)], new ShapeTracker([new View([10], [1], 0, undefined, true)]))], 40)], new ShapeTracker([new View([10], [1], 0, undefined, true)]))], undefined)],
      [new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [6, [`CLANG`, 800, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [7, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 800, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [8, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([3200], [1], 1632, undefined, false)]))], undefined)], new ShapeTracker([new View([800], [1], 0, undefined, true)]))], 3200)], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [7, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 800, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [8, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([3200], [1], 1632, undefined, false)]))], undefined)]]), new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [6, [`CLANG`, 800, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [7, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 800, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [8, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([3200], [1], 1632, undefined, false)]))], undefined)], new ShapeTracker([new View([800], [1], 0, undefined, true)]))], 3200)], new ShapeTracker([new View([800], [1], 0, undefined, true)]))], undefined)],
      [new Map([[new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [15, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [16, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [17, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([128], [1], 107360, undefined, false)]))], undefined)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], 128)], [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [16, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [17, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([128], [1], 107360, undefined, false)]))], undefined)]]), new UOp(Ops.SINK, dtypes.void, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [15, [`CLANG`, 32, dtypes.float]]), new UOp(Ops.COPY, dtypes.float, [new UOp(Ops.VIEW, dtypes.float, [new UOp(Ops.BUFFER, dtypes.float.ptr(), [], [16, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 32, dtypes.float]]), new UOp(Ops.BUFFER_VIEW, dtypes.float, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.VIEW, dtypes.uchar, [new UOp(Ops.BUFFER, dtypes.uchar.ptr(), [], [17, [`DISK:/Users/karel/Documents/denograd/tinygrad/model.safetensors`, 353816, dtypes.uchar]])], new ShapeTracker([new View([353816], [1], 0, undefined, true)]))], new ShapeTracker([new View([128], [1], 107360, undefined, false)]))], undefined)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], 128)], new ShapeTracker([new View([32], [1], 0, undefined, true)]))], undefined)],
    ],
    init_big_graph,
    'out(tiny.engine.schedule.init_big_graph(*data))',
  ),
)

Deno.test(
  'create_schedule_with_vars',
  compare(
    [
      [[new LazyBuffer(`PYTHON`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.int, Ops.EMPTY, undefined, undefined, undefined, undefined)]],
      [[new LazyBuffer(`PYTHON`, new ShapeTracker([new View([5, 2], [2, 1], 0, undefined, true)]), dtypes.int, undefined, undefined, undefined, new LazyBuffer(`PYTHON`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.int, Ops.EMPTY, undefined, undefined, undefined, undefined), new Metadata(`reshape`, ``, false))]],
      [[new LazyBuffer(`PYTHON`, new ShapeTracker([new View([1, 10], [0, 1], 0, undefined, true)]), dtypes.int, undefined, undefined, undefined, new LazyBuffer(`PYTHON`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.int, Ops.EMPTY, undefined, undefined, undefined, undefined), new Metadata(`__getitem__`, ``, false))]],
      [[new LazyBuffer(`PYTHON`, new ShapeTracker([new View([], [], 0, undefined, true)]), dtypes.int, Ops.CONTIGUOUS, undefined, [new LazyBuffer(`PYTHON`, new ShapeTracker([new View([], [], 0, undefined, true)]), dtypes.int, undefined, undefined, undefined, new LazyBuffer(`PYTHON`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.int, Ops.EMPTY, undefined, undefined, undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`data`, ``, false))]],
      [[new LazyBuffer(`PYTHON`, new ShapeTracker([new View([], [], 0, undefined, true)]), dtypes.int, Ops.CONTIGUOUS, undefined, [new LazyBuffer(`PYTHON`, new ShapeTracker([new View([], [], 9, undefined, false)]), dtypes.int, undefined, undefined, undefined, new LazyBuffer(`PYTHON`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.int, Ops.EMPTY, undefined, undefined, undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`data`, ``, false))]],
      [[new LazyBuffer(`PYTHON`, new ShapeTracker([new View([], [], 0, undefined, true)]), dtypes.int, Ops.CONTIGUOUS, undefined, [new LazyBuffer(`PYTHON`, new ShapeTracker([new View([], [], 4, undefined, false)]), dtypes.int, undefined, undefined, undefined, new LazyBuffer(`PYTHON`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.int, Ops.EMPTY, undefined, undefined, undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`data`, ``, false))]],
      [[new LazyBuffer(`PYTHON`, new ShapeTracker([new View([2], [1], 0, undefined, true)]), dtypes.int, Ops.CONTIGUOUS, undefined, [new LazyBuffer(`PYTHON`, new ShapeTracker([new View([2], [1], 0, undefined, true)]), dtypes.int, undefined, undefined, undefined, new LazyBuffer(`PYTHON`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.int, Ops.EMPTY, undefined, undefined, undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`data`, ``, false))]],
      [[new LazyBuffer(`PYTHON`, new ShapeTracker([new View([5], [1], 0, undefined, true)]), dtypes.int, Ops.CONTIGUOUS, undefined, [new LazyBuffer(`PYTHON`, new ShapeTracker([new View([5], [1], 5, undefined, false)]), dtypes.int, undefined, undefined, undefined, new LazyBuffer(`PYTHON`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.int, Ops.EMPTY, undefined, undefined, undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`data`, ``, false))]],
      [[new LazyBuffer(`PYTHON`, new ShapeTracker([new View([4], [1], 0, undefined, true)]), dtypes.int, Ops.CONTIGUOUS, undefined, [new LazyBuffer(`PYTHON`, new ShapeTracker([new View([4], [1], 2, undefined, false)]), dtypes.int, undefined, undefined, undefined, new LazyBuffer(`PYTHON`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.int, Ops.EMPTY, undefined, undefined, undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`data`, ``, false))]],
      [[new LazyBuffer(`PYTHON`, new ShapeTracker([new View([1, 2], [0, 1], 0, undefined, true)]), dtypes.int, Ops.CONTIGUOUS, undefined, [new LazyBuffer(`PYTHON`, new ShapeTracker([new View([1, 2], [0, 1], 2, undefined, false)]), dtypes.int, undefined, undefined, undefined, new LazyBuffer(`PYTHON`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.int, Ops.EMPTY, undefined, undefined, undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`data`, ``, false))]],
      [[new LazyBuffer(`PYTHON`, new ShapeTracker([new View([2, 2], [2, 1], 0, undefined, true)]), dtypes.int, Ops.CONTIGUOUS, undefined, [new LazyBuffer(`PYTHON`, new ShapeTracker([new View([2, 2], [2, 1], 2, undefined, false)]), dtypes.int, undefined, undefined, undefined, new LazyBuffer(`PYTHON`, new ShapeTracker([new View([10], [1], 0, undefined, true)]), dtypes.int, Ops.EMPTY, undefined, undefined, undefined, undefined), new Metadata(`__getitem__`, ``, false))], undefined, new Metadata(`data`, ``, false))]],
      [[new LazyBuffer(`PYTHON`, new ShapeTracker([new View([5], [1], 0, undefined, true)]), dtypes.bool, Ops.CMPNE, undefined, [new LazyBuffer(`PYTHON`, new ShapeTracker([new View([5], [1], 0, undefined, true)]), dtypes.bool, Ops.CMPNE, undefined, [new LazyBuffer(`PYTHON`, new ShapeTracker([new View([5], [1], 0, undefined, true)]), dtypes.float, Ops.EMPTY, undefined, undefined, undefined, undefined), new LazyBuffer(`PYTHON`, new ShapeTracker([new View([5], [0], 0, undefined, false)]), dtypes.float, undefined, undefined, undefined, new LazyBuffer(`PYTHON`, new ShapeTracker([new View([], [], 0, undefined, true)]), dtypes.float, Ops.CONST, Infinity, [], undefined, new Metadata(`isinf`, ``, false)), new Metadata(`isinf`, ``, false))], undefined, new Metadata(`isinf`, ``, false)), new LazyBuffer(`PYTHON`, new ShapeTracker([new View([5], [0], 0, undefined, false)]), dtypes.bool, undefined, undefined, undefined, new LazyBuffer(`PYTHON`, new ShapeTracker([new View([], [], 0, undefined, true)]), dtypes.bool, Ops.CONST, true, [], undefined, new Metadata(`isinf`, ``, false)), new Metadata(`isinf`, ``, false))], undefined, new Metadata(`isinf`, ``, false))]]
    ],
    (outs: LazyBuffer[]) => {
      UOp.buffer_num = counter(0)
      return create_schedule_with_vars(outs)
    },
    'out(tiny.engine.schedule.create_schedule_with_vars(*data))',
    {
      ignoreKeys: ['_lb_refcount'], // this only needs to be ignored when running all tests, when one-by-one it's ok
    },
  ),
)
